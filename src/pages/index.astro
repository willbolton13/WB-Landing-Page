---
import Layout from '../layouts/Layout.astro';
import StaticPortalCards from '../components/StaticPortalCards.astro';
import { 
  getAllHeroImages,
  getRotatingImage,
  getOptimizedImageUrl,
  generateSrcSet
} from '../lib/contentful';

// Get all hero images from all campuses
const allHeroImages = await getAllHeroImages();



// Select a rotating image for the homepage
let heroImage = null;
let heroImageUrl = '/img/hn-1536x796.jpg.webp'; // Fallback
let heroImageSrcSet = null;
let heroImageAlt = 'Welcome to WaterBear';
let heroImageCampus = '';

if (allHeroImages && allHeroImages.length > 0) {
  // Get rotating image object (changes daily)
  const selectedImageData = getRotatingImage(
    allHeroImages, 
    'homepage', // Unique key for homepage
    'daily' // Change daily
  );
  
  console.log('Homepage: Selected image data:', {
    hasSelection: !!selectedImageData,
    campus: selectedImageData?.campusName
  });
  
  if (selectedImageData) {
    heroImage = selectedImageData.asset;
    heroImageCampus = selectedImageData.campusName;
    
    // Generate optimized URLs
    heroImageUrl = getOptimizedImageUrl(heroImage, { 
      width: 1920, 
      quality: 85,
      format: 'webp'
    });
    
    console.log('Homepage: Generated hero URL:', heroImageUrl);
    
    // Generate srcset for responsive images
    heroImageSrcSet = generateSrcSet(heroImage, [640, 768, 1024, 1366, 1920, 2560]);
    
    // Use image description if available
    heroImageAlt = heroImage.fields.description || heroImage.fields.title || `${heroImageCampus} campus`;
  }
} else {
  console.log('Homepage: No hero images found, using fallback');
}

// Generate preload tags for the hero image
const preloadTags = heroImage ? `
  <link rel="preload" as="image" type="image/webp" href="${getOptimizedImageUrl(heroImage, { width: 1920, format: 'webp' })}" media="(min-width: 1024px)">
  <link rel="preload" as="image" type="image/webp" href="${getOptimizedImageUrl(heroImage, { width: 768, format: 'webp' })}" media="(max-width: 1023px)">
` : '';
---

<Layout title="WaterBear Student Portal">
    <!-- Inject preload tags into head -->
    <Fragment slot="head" set:html={preloadTags} />
    
    <section class="hero-section">
        {heroImage ? (
            <picture>
                <!-- WebP for modern browsers -->
                <source
                    type="image/webp"
                    srcset={heroImageSrcSet}
                    sizes="100vw"
                />
                <!-- JPEG fallback -->
                <source
                    type="image/jpeg"
                    srcset={generateSrcSet(heroImage, [640, 768, 1024, 1366, 1920, 2560])}
                    sizes="100vw"
                />
                <!-- Default img tag -->
                <img 
                    src={heroImageUrl}
                    alt={heroImageAlt}
                    loading="eager"
                    fetchpriority="high"
                    width="1920"
                    height="1080"
                />
            </picture>
        ) : (
            <!-- Fallback static image -->
            <img src={heroImageUrl} alt={heroImageAlt} />
        )}
    </section>
    
    <main class="container my-5">
        <div class="text-center">
            <h1 class="display-4">Welcome to your student portal</h1>
        </div>
        
        <StaticPortalCards />
    </main>
</Layout>

<style>
  /* All existing styles remain the same */
  .hero-section {
    height: 55vh;
    overflow: hidden;
    position: relative;
    z-index: 1;
  }

  main.container {
    position: relative;
    z-index: 2;
    margin-top: -40vh !important;
  }

  .hero-section img,
  .hero-section picture {
    width: 100%;
    height: 100%;
  }

  .hero-section img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  h1, .lead {
    color: var(--text-color);
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  }

  .display-4 {
    font-weight: 700;
    text-transform: uppercase;
    min-height: 150px;
  }
</style>