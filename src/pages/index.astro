---
import Layout from '../layouts/Layout.astro';
import StaticPortalCards from '../components/StaticPortalCards.astro';
import ContentRenderer from '../components/ContentRenderer.astro';
import { 
  getAllHeroImages,
  getRotatingImage,
  getOptimizedImageUrl,
  generateSrcSet,
  getPlaceholderImageUrl,
  getResourceWithFullContent,
  findIncludedEntry,
  processEventList,
  processMentorList
} from '../lib/contentful';

// Get all hero images from all campuses
const allHeroImages = await getAllHeroImages();
const homepageSlug = 'homepage'; 
const resourceResponse = await getResourceWithFullContent(homepageSlug);
const resourceData = resourceResponse?.items?.[0] || null;

const eventListsData = {};
const mentorListsData = {};

// Select a rotating image for the homepage
let heroImage = null;
let heroImageUrl = '/img/hn-1536x796.jpg.webp'; // Fallback
let heroImageSrcSet = null;
let heroImageAlt = 'Welcome to WaterBear';
let heroImageCampus = '';
let placeholderUrl = null;
let contentItems = [];

if (allHeroImages && allHeroImages.length > 0) {
  // Get rotating image object (changes daily)
  const selectedImageData = getRotatingImage(
    allHeroImages, 
    'homepage', // Unique key for homepage
    'daily' // Change daily
  );
  
  if (selectedImageData) {
    heroImage = selectedImageData.asset;
    heroImageCampus = selectedImageData.campusName;
    
    // Generate optimized URLs
    heroImageUrl = getOptimizedImageUrl(heroImage, { 
      width: 1920, 
      quality: 85,
      format: 'webp'
    });
    
    // Generate srcset for responsive images
    heroImageSrcSet = generateSrcSet(heroImage, [640, 768, 1024, 1366, 1920, 2560]);
    
    // Generate placeholder for blur-up effect
    placeholderUrl = getPlaceholderImageUrl(heroImage);
    
    // Use image description if available
    heroImageAlt = heroImage.fields.description || heroImage.fields.title || `${heroImageCampus} campus`;
  }
}

if (resourceData && resourceData.fields.pageContent) {
  // Resolve the content items
  contentItems = resourceData.fields.pageContent.map(contentRef => {
    return findIncludedEntry(resourceResponse?.includes, contentRef.sys.id) || contentRef;
  }).filter(item => item?.fields);

  // Pre-fetch dynamic data if needed
  for (const item of contentItems) {
    const contentType = item?.sys?.contentType?.sys?.id;
    
    // Check for Event Lists
    if (contentType === 'eventList') {
      const events = await processEventList(item);
      eventListsData[item.sys.id] = events;
    }
    
    // Check for Mentor Lists
    if (contentType === 'mentorList') {
      const mentors = await processMentorList(item);
      mentorListsData[item.sys.id] = mentors;
    }
  }
}
---

<Layout title="WaterBear Student Portal" heroImageUrl={heroImageUrl}>
    <section class="hero-section" data-hero-section>
        <!-- Black placeholder background -->
        <div class="hero-placeholder"></div>
        
        <!-- Blur placeholder (loads immediately) -->
        {placeholderUrl && (
          <div 
            class="hero-blur"
            style={`background-image: url('${placeholderUrl}')`}
          ></div>
        )}
        
        <!-- Main hero image -->
        {heroImage ? (
            <picture class="hero-picture">
                <!-- WebP for modern browsers -->
                <source
                    type="image/webp"
                    srcset={heroImageSrcSet}
                    sizes="100vw"
                />
                <!-- JPEG fallback -->
                <source
                    type="image/jpeg"
                    srcset={generateSrcSet(heroImage, [640, 768, 1024, 1366, 1920, 2560])}
                    sizes="100vw"
                />
                <!-- Default img tag -->
                <img 
                    class="hero-image"
                    src={heroImageUrl}
                    alt={heroImageAlt}
                    loading="eager"
                    fetchpriority="high"
                    width="1920"
                    height="1080"
                    onload="this.classList.add('loaded')"
                />
            </picture>
        ) : (
            <!-- Fallback static image -->
            <img 
                class="hero-image"
                src={heroImageUrl} 
                alt={heroImageAlt}
                onload="this.classList.add('loaded')"
            />
        )}
    </section>
    
    <main class="container my-5">
        <div class="text-center">
            <h1 class="hero-title hero-title--xl">FRONT OF<br> HOUSE</h1>
            <p class="hero-subtitle--lg">Your Student Portal</p>
        </div>
        <StaticPortalCards />

    {contentItems.length > 0 && (
            <div class="homepage-news-section mt-5">
            
            <div class="news-header-bar">
                    {resourceData.fields.pageTitle || "COLLEGE NEWS"}
                </div>

                {/* Optional: Add a header if the Resource has a pageTitle */}
                {resourceData.fields.pageTitle && resourceData.fields.pageTitle !== 'Homepage' && (
                    <div class="text-center mb-5">
                        <h2 class="hero-title--md">{resourceData.fields.pageTitle}</h2>
                    </div>
                )}

                {/* Render the blocks using your existing renderer */}
                {contentItems.map((item, index) => {
                    const contentType = item?.sys?.contentType?.sys?.id;
                    const eventData = contentType === 'eventList' ? eventListsData[item.sys.id] : null;
                    const mentorData = contentType === 'mentorList' ? mentorListsData[item.sys.id] : null;

                    return (
                        <ContentRenderer 
                            item={item}
                            includes={resourceResponse?.includes}
                            index={index}
                            eventData={eventData}
                            mentorData={mentorData}
                        />
                    );
                })}
            </div>
        )}    

    </main>
</Layout>

<style>
  /* Hero section with blur-up effect */
  .hero-section {
    height: 55vh;
    overflow: hidden;
    position: relative;
    z-index: 1;
    background: #000; /* Black background */
  }
  
  /* ... existing styles ... */

  .homepage-news-section {
    position: relative;
    z-index: 2;
    padding-top: rem;
  }

  /* 1. Black Header Bar Styles */
  .news-header-bar {
    background-color: var(--brand-black);
    color: #ffffff;
    padding: 0.8rem;
    text-align: center;
    
    /* Typography per your guidelines */
    font-family: 'Futura PT', sans-serif;
    font-weight: 800; /* Extra Bold/Heavy */
    font-size: 2rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    line-height: 1;
  }



    /* Black placeholder - always visible */
  .hero-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 1;
  }

  /* Blur placeholder - loads immediately */
  .hero-blur {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    filter: blur(20px);
    transform: scale(1.1); /* Slightly scale to hide blur edges */
    opacity: 0.7;
    z-index: 2;
    transition: opacity 0.3s ease-out;
  }

  /* Hide blur when main image loads */
  .hero-section:has(.hero-image.loaded) .hero-blur {
    opacity: 0;
  }


  .hero-image.loaded {
    opacity: 1;
  }

  main.container {
    position: relative;
    z-index: 2;
    margin-top: -40vh !important;
  }

  h1, .lead {
    color: var(--text-color);
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  }

  p, .lead {
    font-family: "jost", sans-serif;
    color: var(--text-color);
    font-weight: 500;
    margin-top: 0.5rem;
    margin-bottom: 2rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
  }

  /* Fallback for browsers that don't support :has() */
  @supports not selector(:has(*)) {
    .hero-blur {
      animation: fadeOut 0.6s ease-out 0.5s forwards;
    }
    
    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }
  }

    .text-center.lead p {
    font-family: "Jost", sans-serif;
  }
</style>