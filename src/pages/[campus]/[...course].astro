---
import Layout from '../../layouts/Layout.astro';
import StaticPortalCards from '../../components/StaticPortalCards.astro';
import { 
  getCampuses,
  getCampusWithHeroImages,
  getCourseWithFullContent,
  findIncludedEntry,
  findIncludedAsset,
  contentfulClient,
  getRotatingImage,
  getOptimizedImageUrl,
  generateSrcSet,
  getPlaceholderImageUrl
} from '../../lib/contentful';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';

// Generate static paths for all campus and campus/course combinations
export async function getStaticPaths() {
  const campuses = await getCampuses();
  const paths = [];
  
  for (const campus of campuses) {
    // Fetch campus with all needed data ONCE
    const campusWithFullData = await getCampusWithHeroImages(campus.fields.campusSlug);
    
    // Resolve courses if they exist
    let resolvedCourses = [];
    if (campusWithFullData.fields.courses && campusWithFullData.fields.courses.length > 0) {
      // Check if courses are already resolved objects
      if (campusWithFullData.fields.courses[0]?.fields) {
        resolvedCourses = campusWithFullData.fields.courses;
      } else {
        // Batch fetch all courses at once
        const courseIds = campusWithFullData.fields.courses.map(c => c.sys.id).join(',');
        const coursesResponse = await contentfulClient.getEntries({
          'sys.id[in]': courseIds,
          content_type: 'location',
          include: 1
        });
        resolvedCourses = coursesResponse.items;
      }
      // Sort courses
      resolvedCourses.sort((a, b) => 
        (a.fields.displayOrder || 0) - (b.fields.displayOrder || 0)
      );
    }
    
    // Resolve custom portal buttons if they exist
    let customPortalButtons = [];
    if (campusWithFullData.fields.useCustomButtons && campusWithFullData.fields.customPortalButtons) {
      // Check if buttons are already resolved
      if (campusWithFullData.fields.customPortalButtons[0]?.fields) {
        customPortalButtons = campusWithFullData.fields.customPortalButtons;
      } else {
        // Batch fetch buttons
        const buttonIds = campusWithFullData.fields.customPortalButtons.map(b => b.sys.id).join(',');
        const buttonsResponse = await contentfulClient.getEntries({
          'sys.id[in]': buttonIds
        });
        customPortalButtons = buttonsResponse.items;
      }
    }
    
    // Add campus landing page path with all data as props
    paths.push({
      params: { 
        campus: campus.fields.campusSlug,
        course: undefined
      },
      props: {
        campusData: campusWithFullData,
        courses: resolvedCourses,
        customPortalButtons,
        isCampusPage: true,
        courseData: null,
        courseResponse: null
      }
    });
    
    // Add course paths with their data
    for (const course of resolvedCourses) {
      // Fetch full course content
      const courseResponse = await getCourseWithFullContent(
        campus.fields.campusSlug, 
        course.fields.courseSlug
      );
      
      paths.push({
        params: { 
          campus: campus.fields.campusSlug,
          course: course.fields.courseSlug
        },
        props: {
          campusData: campusWithFullData,
          courses: resolvedCourses,
          customPortalButtons,
          isCampusPage: false,
          courseData: courseResponse?.items?.[0] || null,
          courseResponse: courseResponse
        }
      });
    }
  }
  
  return paths;
}

// Get all data from props instead of fetching again
const { 
  campusData, 
  courses, 
  customPortalButtons,
  isCampusPage,
  courseData,
  courseResponse
} = Astro.props;

// Get params for potential redirects or error handling
const { campus } = Astro.params;
const courseSlug = Astro.params.course;

// Redirect if no campus data (shouldn't happen with static generation)
if (!campusData) {
  return Astro.redirect('/');
}

// Set page title based on page type
const pageTitle = isCampusPage 
  ? (campusData.fields.welcomeHeading || `Welcome ${campusData.fields.campusName} Students`)
  : (courseData ? (courseData.fields.pageTitle || courseData.fields.courseName) : 'Course');

// ============= HERO IMAGE SELECTION =============
// Select hero image using time-based rotation
let heroImage = null;
let heroImageUrl = null;
let heroImageSrcSet = null;
let heroImageAlt = 'Campus hero image';
let placeholderUrl = null;

// Check if campus has hero images
if (campusData.fields.heroImagePool && campusData.fields.heroImagePool.length > 0) {
  // Create unique key for this page (different image for campus vs course pages)
  const pageKey = isCampusPage ? campus : `${campus}-${courseSlug}`;
  
  // Get rotating image (changes daily)
  heroImage = getRotatingImage(
    campusData.fields.heroImagePool, 
    pageKey, 
    'daily'
  );
  
  if (heroImage) {
    // Generate optimized URLs for different screen sizes
    heroImageUrl = getOptimizedImageUrl(heroImage, { 
      width: 1920, 
      quality: 85,
      format: 'webp'
    });
    
    // Generate srcset for responsive images
    heroImageSrcSet = generateSrcSet(heroImage, [640, 768, 1024, 1366, 1920, 2560]);
    
    // Generate placeholder for blur-up effect
    placeholderUrl = getPlaceholderImageUrl(heroImage);
    
    // Use image description if available
    heroImageAlt = heroImage.fields.description || heroImage.fields.title || heroImageAlt;
  }
}

// Fallback to static image if no hero images available
if (!heroImageUrl) {
  heroImageUrl = '/img/hn-1536x796.jpg.webp';
}
---

<Layout title={pageTitle} heroImageUrl={heroImageUrl}>
  <section class="hero-section" data-hero-section>
    <!-- Black placeholder background -->
    <div class="hero-placeholder"></div>
    
    <!-- Blur placeholder (loads immediately) -->
    {placeholderUrl && (
      <div 
        class="hero-blur"
        style={`background-image: url('${placeholderUrl}')`}
      ></div>
    )}
    
    <!-- Main hero image -->
    {heroImage ? (
      <picture class="hero-picture">
        <!-- WebP for modern browsers -->
        <source
          type="image/webp"
          srcset={heroImageSrcSet}
          sizes="100vw"
        />
        <!-- JPEG fallback -->
        <source
          type="image/jpeg"
          srcset={generateSrcSet(heroImage, [640, 768, 1024, 1366, 1920, 2560])}
          sizes="100vw"
        />
        <!-- Default img tag -->
        <img 
          class="hero-image"
          src={heroImageUrl}
          alt={heroImageAlt}
          loading="eager"
          fetchpriority="high"
          width="1920"
          height="1080"
          onload="this.classList.add('loaded')"
        />
      </picture>
    ) : (
      <!-- Fallback static image -->
      <img 
        class="hero-image" 
        src={heroImageUrl} 
        alt={heroImageAlt}
        onload="this.classList.add('loaded')"
      />
    )}
  </section>
  
  <main class="container mb-5">
    {isCampusPage ? (
      // CAMPUS PAGE CONTENT
      <>
        <div class="text-center">
          <h1 class="hero-title hero-title--lg">{pageTitle}</h1>
          
          {/* Course Selection - Simple buttons right under the header */}
          {courses && courses.length > 0 && (
            <div class="course-selection">
              {courses.length > 1 && (
                <p class="course-prompt">Select your course:</p>
              )}
              <div class="course-buttons">
                {courses.map((courseItem) => (
                  <a 
                    href={`/${campus}/${courseItem.fields.courseSlug}`}
                    class="course-btn"
                  >
                    {courseItem.fields.courseName}
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
        
        {/* Portal Cards - either custom or static based on campus settings */}
        {campusData.fields.useCustomButtons && customPortalButtons.length > 0 ? (
          <>
            {/* Custom portal buttons for this campus */}
            <div class="row g-4 justify-content-center mb-4">
              {customPortalButtons.map((button) => (
                <div class="col-lg-6 col-md-6">
                  <a href={button.fields.link} target="_blank" class="portal-card custom-portal-card">
                    <div class="portal-card-icon">
                      <i data-lucide={button.fields.icon || 'square'}></i>
                    </div>
                    <h3>{button.fields.buttonText}</h3>
                    <p class="portal-card-subtitle">{button.fields.buttonSubtitle || ''}</p>
                  </a>
                </div>
              ))}
            </div>
          </>
        ) : (
          // Default static portal cards
          <StaticPortalCards />
        )}
      
      </>
    ) : courseData ? (
      // COURSE PAGE CONTENT
      <>
        <div class="text-center">
          <h1 class="hero-title hero-title--lg">{pageTitle}</h1>
          <p class="course-subtitle">{courseData.fields.courseName}</p>
        </div>
        
       {/* --- TOGGLE CONTROL (Only if Info Blocks exist) --- */}
        {courseData.fields.informationBlocks && courseData.fields.informationBlocks.length > 0 && (
          <div class="view-toggle-container">
            <div class="view-toggle">
              <button class="toggle-btn active" data-target="quick-links-view">
                <i data-lucide="layout-grid"></i> Quick Links
              </button>

              <button class="toggle-btn" data-target="news-view">
                <i data-lucide="newspaper"></i> News & Info

              <span class="notification-badge">
                  {courseData.fields.informationBlocks.length}
                </span>
              </button>
            </div>
          </div>
        )}

        {/* --- VIEW 1: QUICK LINKS (Default) --- */}
        <div id="quick-links-view" class="view-section active">
          
          {/* Portal Cards */}
          {campusData.fields.useCustomButtons && customPortalButtons.length > 0 ? (
            <div class="row g-4 justify-content-center mb-4">
              {customPortalButtons.map((button) => (
                <div class="col-lg-6 col-md-6">
                  <a href={button.fields.link} target="_blank" class="portal-card custom-portal-card">
                    <div class="portal-card-icon">
                      <i data-lucide={button.fields.icon || 'square'}></i>
                    </div>
                    <h3>{button.fields.buttonText}</h3>
                    <p class="portal-card-subtitle">{button.fields.buttonSubtitle || ''}</p>
                  </a>
                </div>
              ))}
            </div>
          ) : (
            <StaticPortalCards />
          )}
          
          {/* Dynamic Course Buttons (Location Buttons) */}
          {courseData.fields.locationButtons && courseData.fields.locationButtons.length > 0 && (
            <div class="row g-4 justify-content-center mb-4">
              {courseData.fields.locationButtons.map((buttonRef) => {
                const button = findIncludedEntry(courseResponse.includes, buttonRef.sys.id);
                if (!button) return null;
                
                return (
                  <div class="portal-cards-container col-lg-6 col-md-6">
                    <a href={button.fields.link} target="_blank" class="portal-card portal-card-green">
                      <div class="portal-card-icon">
                        <i data-lucide={button.fields.icon || 'square'}></i>
                      </div>
                      <h3>{button.fields.buttonText}</h3>
                      <p class="portal-card-subtitle">{button.fields.buttonSubtitle || ''}</p>
                    </a>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* --- VIEW 2: NEWS / INFORMATION BLOCKS --- */}
        {courseData.fields.informationBlocks && courseData.fields.informationBlocks.length > 0 && (
          <div id="news-view" class="view-section">
            {courseData.fields.informationBlocks.map((blockRef, index) => {
            
              const block = findIncludedEntry(courseResponse.includes, blockRef.sys.id);
              if (!block) return null;
              
              const imageAsset = block.fields.image ? 
                findIncludedAsset(courseResponse.includes, block.fields.image.sys.id) : null;
              const imageUrl = imageAsset ? 
                  `https:${imageAsset.fields.file.url}?w=1200&q=80` : null;
              
              const contentHtml = block.fields.content 
                ? documentToHtmlString(block.fields.content)
                : '';
              

              const bgColor = block.fields.backgroundColor || 'White';
              const bgClass = bgColor !== 'None' ? `bg-${bgColor.toLowerCase()}` : '';

              const hasImage = !!imageUrl;
              const layoutClass = hasImage && index % 2 === 1 ? 'image-left' : '';
              
              // NEW: Added bgClass to the wrapper div
              return (
                <div class={`content-block ${layoutClass} ${!hasImage ? 'no-image' : ''} ${bgClass}`}>
                  {hasImage ? (
                    <div class="row align-items-center justify-content-between">
                      <div class="col-md-7 content-block-text">
                         <h2>{block.fields.heading}</h2>
                        <div set:html={contentHtml}></div>
                      </div>
                      <div class="col-md-5 content-block-image">
                         <img src={imageUrl} class="img-fluid" alt={block.fields.heading} />
                        {block.fields.buttonText && block.fields.buttonLink && (
                          <a href={block.fields.buttonLink} target="_blank" class="overlap-btn">
                             {block.fields.buttonText}
                          </a>
                        )}
                      </div>
                    </div>
                   ) : (
                    <div class="row">
                      <div class="col-md-12 content-block-text">
                        <h2>{block.fields.heading}</h2>
                         <div set:html={contentHtml}></div>
                        {block.fields.buttonText && block.fields.buttonLink && (
                          <div class="button-container">
                            <a href={block.fields.buttonLink} target="_blank" class="overlap-btn position-relative">
                               {block.fields.buttonText}
                            </a>
                          </div>
                    
                         )}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}
        
        {/* Staff Section */}
        {courseData.fields.centreStaff && courseData.fields.centreStaff.length > 0 && (
          <div class="staff-section">
            <div class="section-divider"></div>
            <div class="row">
              {courseData.fields.centreStaff.map((staffRef) => {
                const staff = findIncludedEntry(courseResponse.includes, staffRef.sys.id);
                if (!staff) return null;
                
                const photoAsset = staff.fields.photo ? 
                  findIncludedAsset(courseResponse.includes, staff.fields.photo.sys.id) : null;
                const photoUrl = photoAsset ? 
                  `https:${photoAsset.fields.file.url}?w=1000&h=1000&fit=crop&f=face&q=50` : 
                  `https://placehold.co/300x300/DE0029/FFFFFF?text=${encodeURIComponent(staff.fields.fullName.charAt(0))}`;
                
                return (
                  <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                    <div class="staff-member">
                      <div class="staff-photo">
                        <img src={photoUrl} alt={staff.fields.fullName} class="img-fluid">
                      </div>
                      <div class="staff-info">
                        <h4 class="staff-name">{staff.fields.fullName}</h4>
                        <p class="staff-title">{staff.fields.jobTitle}</p>
                        <a href={`mailto:${staff.fields.staffEmail}`} class="staff-email">
                          {staff.fields.staffEmail}
                        </a>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </>
    ) : (
      // ERROR STATE
      <div class="text-center">
        <h1>Course Not Found</h1>
        <p>
          <a href={`/${campus}`} class="btn btn-secondary">‚Üê Back to {campusData.fields.campusName} Campus</a>
        </p>
      </div>
    )}
  </main>
</Layout>

<style>
  /* Hero section with blur-up effect */
  .hero-section {
    height: 55vh;
    overflow: hidden;
    position: relative;
    z-index: 1;
    background: #000; /* Black background */
  }

  /* Black placeholder - always visible */
  .hero-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 1;
  }

  /* Blur placeholder - loads immediately */
  .hero-blur {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    filter: blur(20px);
    transform: scale(1.1); /* Slightly scale to hide blur edges */
    opacity: 0.7;
    z-index: 2;
    transition: opacity 0.3s ease-out;
  }

  /* Hide blur when main image loads */
  .hero-section:has(.hero-image.loaded) .hero-blur {
    opacity: 0;
  }

  /* Fallback for browsers that don't support :has() */
  @supports not selector(:has(*)) {
    .hero-blur {
      animation: fadeOut 0.6s ease-out 0.5s forwards;
    }
    
    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }
  }

  .hero-image.loaded {
    opacity: 1;
  }

  /* Rest of your existing styles remain the same... */
  main.container {
    position: relative;
    z-index: 2;
    margin-top: -50vh !important;
  }

  .text-center {
    min-height: 250px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding-top: 20px;
  }

  .course-subtitle {
    color: var(--text-color);
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    font-size: 1.5rem;
    text-transform: uppercase;
    margin-top: 0.5rem;
  }

  /* Course selection - simple white outline buttons */
  .course-selection {
    margin-bottom: 2rem;
  }

  .course-prompt {
    font-family: "jost", sans-serif;
    color: var(--text-color);
    font-size: 1.6rem;
    font-weight: 500;
    margin-top: 0.5rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
  }

  .course-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .course-btn {
    padding: 0.75rem 2rem;
    background-color: var(--button-text-color);
    color: var(--text-color);
    text-decoration: none;
    font-weight: 700;
    font-size: 1.6rem;
    border-radius: 3px;
    text-transform: uppercase;
    transition: all 0.2s ease;
    box-shadow: 2px 4px 4px rgba(0, 0, 0, 0.7);
    display: inline-block;
  }

  .course-btn:hover {
    background-color: var(--text-color);
    color: var(--button-text-color);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.0);
  }

  .alert {
    max-width: 600px;
    margin: 3rem auto;
  }
  /* Content blocks */
  .content-block {
    margin-bottom: 3rem;
    padding: 2rem;
    border-radius: 2px;
    transition: background-color 0.3s ease;
  }

  .content-block-text h2,
  .content-block-text p {
    color: #000;
    text-shadow: none;
  }

  .content-block-text h2{
    font-size: 1.8rem;
    font-weight: 700;
    text-transform: uppercase;
    font-family: "Futura pt", sans-serif;
    margin-bottom: 20px;
    
  }

  @media (max-width: 768px) { 
    .content-block-text h2{
      text-align: center;
      width fit-content;
      font-size: 1.5rem;
      top: -10px;
      
      


    }
  }

  @media (min-width: 768px) {
    .content-block.image-left .content-block-text {
      order: 2;
    }
    .content-block.image-left .content-block-image {
      order: 1;
    }
  }
  .content-block {
    position: relative;
  }

  .content-block-image {
    position: static;
  }

  .overlap-btn {
    position: absolute;
    bottom: -20px;
    right: -20px;
    left: auto;
    background-color: #000000; 
    color: #ffffff !important;
    padding: 10px 25px;
    border-radius: 2px;
    font-weight: 700;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid transparent; /* Prepare for hover states */
  }

  .content-block.image-left .overlap-btn {
    right: auto;       /* Unset the default right position */
    left: -20px;       /* Hang off the left edge */
  }

  @media (max-width: 768px) {
    .content-block-text a.overlap-btn,
    .overlap-btn {
      position: static;

      display: block;
      width fit-content;
      margin-top: 1.5rem;

      left: auto !important;
      right: auto !important;
      
      text-align: center;
    }
    .content-block.image-left .overlap-btn {
      left: auto !important;
      right: auto !important;
    }
  }

  .overlap-btn:hover {
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    transform: scale(1.05);
    background-color: var(--accent-yellow); /* Optional: Pop color on hover */
    color: #000000;
  }

  .bg-red {
    background-color: #DE0029;
    color: white;
  }

  .bg-yellow {
    background-color: #F6DD0D;
    color: #000;
  }

  .bg-green {
    background-color: #6D9D7E;
    color: white;
  }

  .bg-white {
    background-color: #FFFFFF;
    color: #000;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .bg-black {
    background-color: #000000;
    color: white;
  }
  
  /* Ensure headings are white on dark backgrounds */
  .bg-red h2,
  .bg-green h2,
  .bg-black h2 {
    color: white !important;
    text-shadow: none;
  }

  /* Ensure headings are black on light backgrounds */
  .bg-yellow h2,
  .bg-white h2 {
    color: #000 !important;
    text-shadow: none;
  }

  /* Handle Rich Text Links on dark backgrounds */
  .bg-red .content-block-text :global(a),
  .bg-green .content-block-text :global(a),
  .bg-black .content-block-text :global(a) {
    color: white !important;
    text-decoration-color: rgba(255,255,255, 0.5);
  }

  /* Handle Rich Text Paragraphs on dark backgrounds */
  .bg-red .content-block-text :global(p),
  .bg-green .content-block-text :global(p),
  .bg-black .content-block-text :global(p),
  .bg-red .content-block-text :global(li),
  .bg-green .content-block-text :global(li),
  .bg-black .content-block-text :global(li) {
    color: white !important;
  }
  
  /* Special handling for the button if the background is also black */
  .bg-black .overlap-btn {
    background-color: #ffffff !important;
    color: #bc1c1cd7 !important;
  }

  /* Staff section */
  .staff-section {
    margin-top: 4rem;
  }

  .section-divider {
    height: 3px;
    background-color: var(--button-text-color);
    margin: 2rem 0 3rem 0;
    border-radius: 2px;
  }

  .staff-member {
    text-align: center;
    padding: 1rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .staff-member:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }

  .staff-photo {
    width: 120px;
    height: 120px;
    margin: 0 auto 1rem auto;
    border-radius: 8px;
    overflow: hidden;
    background-color: var(--accent-red);
  }

  .staff-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .staff-info {
    color: #000;
  }

  .staff-name {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: #000;
    text-transform: uppercase;
  }

  .staff-title {
    font-size: 1rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .staff-email {
    font-size: 0.9rem;
    color: var(--accent-red);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease;
  }

  .staff-email:hover {
    color: var(--accent-green);
    text-decoration: underline;
  }

  .btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    text-decoration: none;
    border-radius: 5px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background-color: var(--accent-green);
    color: var(--text-color);
  }

  .btn-primary:hover {
    background-color: var(--text-color);
    color: var(--button-text-color);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background-color: var(--accent-yellow);
    color: var(--button-text-color);
  }

  .btn-secondary:hover {
    background-color: var(--text-color);
    color: var(--button-text-color);
    transform: translateY(-2px);
  }

  /* Button container for no-image blocks */
  .content-block.no-image .button-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 1rem;
  }

  /* Make the button position relative when no image */
  .content-block.no-image .overlap-btn.position-relative {
    position: relative;
    bottom: auto;
    right: auto;
  }

  /* Optional: Add some padding to no-image blocks if needed */
  .content-block.no-image {
    padding: 2rem;
  }

  @media (max-width: 768px) {
    .course-buttons {
      flex-direction: column;
      align-items: center;
    }

    .btn-course {
      width: 100%;
      max-width: 300px;
    }
  }

    h1, .lead {
    color: var(--text-color);
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  }

/* =========================================
     RICH TEXT STYLING (Parity with ContentRenderer)
     ========================================= */

  /* --- Tables --- */
  .content-block-text :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.95rem;
  }

  /* Table Headers */
  .content-block-text :global(th) {
    font-family: "Futura PT", sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    padding: 1rem 0.5rem;
    border-bottom: 2px solid #000;
    vertical-align: bottom;
  }

  /* Table Cells */
  .content-block-text :global(td) {
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
    font-weight: 400 !important;
  }

  /* Striped rows */
  .content-block-text :global(tr:nth-child(even)) {
    background-color: rgba(0, 0, 0, 0.02);
  }

  /* Mobile responsiveness for tables */
  @media (max-width: 768px) {
    .content-block-text :global(table) {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }

  /* --- Lists (Custom Square Bullets) --- */
  .content-block-text :global(ul) {
    list-style: none;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
  }

  .content-block-text :global(li) {
    position: relative;
    margin-bottom: 0.75rem;
    line-height: 1.4;
  }

  .content-block-text :global(li::before) {
    content: "";
    position: absolute;
    left: -1.5rem;
    top: 0.7em;
    width: 8px;
    height: 8px;
    background-color: currentColor; /* Matches text color */
  }

  /* --- Links --- */
  .content-block-text :global(a) {
    color: inherit !important;
    font-weight: 700;
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 4px;
    transition: opacity 0.2s ease;
  }

  .content-block-text :global(a:hover) {
    opacity: 0.6;
    text-decoration-thickness: 3px;
  }
/* =========================================
     TOGGLE VIEW STYLING
     ========================================= */
  .view-toggle-container {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
    position: relative;
    z-index: 10;
  }

  .view-toggle {
    overflow: visible;
    display: inline-flex;
    background: rgba(255, 255, 255, 1);
    backdrop-filter: blur(5px);
    border: 2px solid var(--button-text-color); /* Black */
    border-radius: 1px;
    padding: 4px;
    gap: 0;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
  }

  .toggle-btn {
    position: relative;
    background: transparent;
    border: none;
    padding: 0.6rem 1.8rem;
    border-radius: 1px;
    font-family: 'Futura PT', sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 1.1rem;
    color: var(--button-text-color); /* Black */
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1;
  }

  .notification-badge {
    position: absolute;
    top: -15px;
    right: -15px;
    background-color: var(--accent-red); /* Brand Red */
    color: #ffffff;
    font-family: 'Futura PT', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    
    width: 30px;
    height: 30px;
    
    /* Centering the number */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Visual Pop */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: 2px solid #000000; /* White border to separate from background */
    z-index: 20;
    
    /* Animation (optional - makes it pop in) */
    animation: badgePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes badgePop {
    from { transform: scale(0); }
    to { transform: scale(1); }
  }

  .toggle-btn i {
    width: 18px;
    height: 18px;
  }

  .toggle-btn:hover {
    background-color: rgba(0,0,0,0.05);
    scale: 1.03;
  }

  .toggle-btn.active {
    background-color: var(--button-text-color); /* Black */
    color: var(--text-color); /* White */
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }



  /* View Sections */
  .view-section {
    display: none; /* Hidden by default */
    animation: fadeInSlide 0.4s ease-out forwards;
  }

  .view-section.active {
    display: block; /* Visible when active */
  }

  @keyframes fadeInSlide {
    from { 
      opacity: 0; 
      transform: translateY(15px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

.content-block-text a.overlap-btn {
    color: #ffffff !important;
    text-decoration: none !important;
  }

  /* Fix for Black Backgrounds when button is inside text */
  .bg-black .content-block-text a.overlap-btn {
    background-color: #ffffff;
    color: #000000 !important;
  }
  
  /* Fix hover state when button is inside text */
  .content-block-text a.overlap-btn:hover {
     color: #000000 !important;
     background-color: var(--accent-yellow);
     opacity: 1 !important;
  }


</style>

<script>
  import { animate, inView } from "motion";

  function setupPageAnimationsAdvanced() {
    const animationConfig = {
      initialY: '30px',
      duration: 0.5,
      ease: 'ease-out',
      margin: '50px 0px',
      staggerAmount: 0.07,
      visibilityThreshold: 0.1
    };

    function applyScrollAnimation(element, index, calculateDelay) {
      const observer = new IntersectionObserver(
        (entries) => {
          const entry = entries[0];
          
          if (entry.isIntersecting && entry.intersectionRatio >= animationConfig.visibilityThreshold) {
            observer.disconnect();
          } else {
            element.style.opacity = '0';
            element.style.transform = `translateY(${animationConfig.initialY})`;
            
            const delay = calculateDelay(index, animationConfig.staggerAmount);
            
            observer.disconnect();
            
            inView(element, () => {
              animate(element, 
                { opacity: 1, transform: 'translateY(0px)' }, 
                { duration: animationConfig.duration, ease: animationConfig.ease, delay: delay }
              );
            }, { margin: animationConfig.margin });
          }
        },
        { threshold: animationConfig.visibilityThreshold }
      );
      
      observer.observe(element);
    }

    requestAnimationFrame(() => {
      document.querySelectorAll('.portal-card').forEach((el, i) => {
        applyScrollAnimation(el, i, (index, stagger) => index * stagger);
      });

      document.querySelectorAll('.course-btn').forEach((el, i) => {
        applyScrollAnimation(el, i, (index, stagger) => index * stagger * 0.5);
      });

      document.querySelectorAll('.content-block').forEach((el, i) => {
        applyScrollAnimation(el, i, () => 0);
      });

      document.querySelectorAll('.staff-member').forEach((el, i) => {
        applyScrollAnimation(el, i, (index, stagger) => (index % 4) * stagger);
      });
    });
  }
  
  // Parallax effect for hero title
  function setupParallax() {
    const heroTitle = document.querySelector('.hero-title');
    if (!heroTitle) return;
    
    let ticking = false;
    function updateParallax() {
      const scrolled = window.pageYOffset;
      const rate = scrolled * -0.3; // Negative for upward movement
      
      if (scrolled < 600) { // Only apply for first 600px of scroll
        heroTitle.style.transform = `translateY(${rate}px)`;
        heroTitle.style.opacity = Math.max(0.3, 1 - (scrolled / 800)); // Fade but keep minimum opacity
      }
      ticking = false;
    }
    
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(updateParallax);
        ticking = true;
      }
    });
  }

function setupViewToggle() {
    const toggleButtons = document.querySelectorAll('.toggle-btn');
    const sections = document.querySelectorAll('.view-section');

    if (toggleButtons.length === 0) return;

    toggleButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // 1. Deactivate all buttons
        toggleButtons.forEach(b => b.classList.remove('active'));
        // 2. Activate clicked button
        btn.classList.add('active');

        // 3. Hide all sections
        sections.forEach(s => s.classList.remove('active'));
        
        // 4. Show target section
        const targetId = btn.getAttribute('data-target');
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.add('active');
          
          // Optional: Re-trigger scroll animations for the new content
          // if you want the "fade in up" effect to re-run
          if (window.lucide) window.lucide.createIcons();
        }
      });
    });
  }


document.addEventListener('astro:page-load', () => {
  setupPageAnimationsAdvanced();
  setupViewToggle();
  //setupParallax(); 
});
</script>